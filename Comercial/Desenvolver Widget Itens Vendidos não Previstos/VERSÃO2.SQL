SELECT TO_CHAR(NSA001_DTEMISSAO, 'MM')||'/'||TO_CHAR(NSA001_DTEMISSAO, 'RRRR') PERIODO, 
        DECODE(PVB001_PRODUTOCONF, 0, PVB001_PRODUTO, PVB001_PRODUTO||'-'||PVB001_PRODUTOCONF) PRODUTO, 
        CQFBA019(PVB001_GRUPO, PVB001_EMPRESA, PVB001_PRODUTO, PVB001_PRODUTOCONF) DESCRICAO, 
        TAA054_DESCRICAO SEGMENTO, 
        SUM(NSB001_QTDE) QTDVEND, 
        NSB001_UMVENDA UM, 
        TO_CHAR(ROUND(SUM(NSB001_QTDE),0), 99999999)||TO_CHAR(PVB001_PRODUTO, 99999999)||TO_CHAR( 1000, 99999999) SEQUENCIA 
 
FROM PVTBB001, NSTBA001, NSTBB001, ESTBP001, TATBA008, TATBA054, PPTBA004 
 
WHERE PVB001_GRUPO = NSA001_GRUPO 
  AND PVB001_EMPRESA = NSA001_EMPRESA 
  AND PVB001_FILIAL = NSA001_FILIAL 
 
  AND PVB001_GRUPO = NSB001_GRUPO 
  AND PVB001_EMPRESA = NSB001_EMPRESA 
  AND PVB001_FILIAL = NSB001_FILIAL 
  AND PVB001_PRODUTO = NSB001_PRODUTO 
  AND PVB001_PRODUTOCONF = NSB001_PRODUTOCONF 
 
  AND NSB001_TIPODOC = NSA001_TIPODOC 
  AND NSB001_NOTA = NSA001_NOTA 
  AND NSB001_SERIE = NSA001_SERIE 
   
  AND ESP001_GRUPO = PVB001_GRUPO 
  AND ESP001_EMPRESA = PVB001_EMPRESA 
  AND ESP001_FILIAL = PVB001_FILIAL 
  AND ESP001_PRODUTO = PVB001_PRODUTO 
  AND ESP001_PRODUTOCONF = PVB001_PRODUTOCONF 
   
  AND TAA008_CONDICAO = NSA001_CONDICAO 
   
  AND TAA054_SEGMENTO = PPA004_SEGMENTO 
  AND TAA054_GRUPOPESSOA = PPA004_GRUPOPESSOA 
 
  AND PPA004_PESSOA = NSA001_CLIENTE 
   
  AND PVB001_ANO = NVL(:ANO, TO_CHAR(SYSDATE, 'YYYY')) 
  AND PVB001_PERIODO = NVL(:MES, TO_CHAR(SYSDATE, 'MM')) 
     
  AND TO_CHAR(NSA001_DTEMISSAO, 'YYYY') = PVB001_ANO 
  AND TO_CHAR(NSA001_DTEMISSAO, 'MM') = PVB001_PERIODO 
   
  AND NSA001_CANCELADA LIKE 'N' 
  AND TAA008_FATURAMENTO LIKE 'S' 
  AND PPA004_SEGMENTO NOT IN (21, 51) 
  AND ESP001_TPPLANEJAM NOT IN (4) 
  AND NSB001_QTDE <> 0 
  AND PVB001_QTDEPREV = 0 
 
GROUP BY TO_CHAR(NSA001_DTEMISSAO, 'RRRR'), TO_CHAR(NSA001_DTEMISSAO, 'MM'), 
        PVB001_PRODUTO, PVB001_PRODUTOCONF, 
        CQFBA019(PVB001_GRUPO, PVB001_EMPRESA, PVB001_PRODUTO, PVB001_PRODUTOCONF), 
        TAA054_DESCRICAO, NSB001_UMVENDA 
         
UNION  
 
SELECT TO_CHAR(PVA002_DATAINI, 'MM')||'/'||TO_CHAR(PVA002_DATAINI, 'RRRR') PERIODO, 
        DECODE(PVA002_PRODUTOCONF, 0, PVA002_PRODUTO, PVA002_PRODUTO||'-'||PVA002_PRODUTOCONF) PRODUTO, 
        CQFBA019(PVA002_GRUPO, PVA002_EMPRESA, PVA002_PRODUTO, PVA002_PRODUTOCONF) DESCRICAO, 
        NULL SEGMENTO, 
        PVA002_PERCENTUAL QTDVEND, 
        NULL UM, 
        TO_CHAR(ROUND(SUM(NSB001_QTDE),0), 99999999)||TO_CHAR(PVB001_PRODUTO, 99999999)||TO_CHAR(PVA002_PERCENTUAL, 99999999)||TO_CHAR(PVA002_PRODUTO, 99999999) SEQUENCIA 
 
FROM PVTBB001, PVTBA002, NSTBA001, NSTBB001, ESTBP001, TATBA008, TATBA054, PPTBA004 
 
WHERE PVA002_GRUPO = PVB001_GRUPO 
  AND PVA002_EMPRESA = PVB001_EMPRESA 
  AND PVA002_FILIAL = PVB001_FILIAL 
  AND PVA002_PRODUTOG = PVB001_PRODUTO 
  AND PVA002_PRODUTOCONFG = PVB001_PRODUTOCONF 
 
  AND PVB001_GRUPO = NSA001_GRUPO 
  AND PVB001_EMPRESA = NSA001_EMPRESA 
  AND PVB001_FILIAL = NSA001_FILIAL 
 
  AND PVB001_GRUPO = NSB001_GRUPO 
  AND PVB001_EMPRESA = NSB001_EMPRESA 
  AND PVB001_FILIAL = NSB001_FILIAL 
  AND PVB001_PRODUTO = NSB001_PRODUTO 
  AND PVB001_PRODUTOCONF = NSB001_PRODUTOCONF 
 
  AND NSB001_TIPODOC = NSA001_TIPODOC 
  AND NSB001_NOTA = NSA001_NOTA 
  AND NSB001_SERIE = NSA001_SERIE 
 
  AND ESP001_GRUPO = PVB001_GRUPO 
  AND ESP001_EMPRESA = PVB001_EMPRESA 
  AND ESP001_FILIAL = PVB001_FILIAL 
  AND ESP001_PRODUTO = PVB001_PRODUTO 
  AND ESP001_PRODUTOCONF = PVB001_PRODUTOCONF 
   
  AND TAA008_CONDICAO = NSA001_CONDICAO 
   
  AND TAA054_SEGMENTO = PPA004_SEGMENTO 
  AND TAA054_GRUPOPESSOA = PPA004_GRUPOPESSOA 
   
  AND PPA004_PESSOA = NSA001_CLIENTE 
   
  AND PVB001_ANO = NVL(:ANO, TO_CHAR(SYSDATE, 'YYYY')) 
  AND PVB001_PERIODO = NVL(:MES, TO_CHAR(SYSDATE, 'MM')) 
     
  AND TO_CHAR(NSA001_DTEMISSAO, 'YYYY') = PVB001_ANO 
  AND TO_CHAR(NSA001_DTEMISSAO, 'MM') = PVB001_PERIODO 
   
  AND TRUNC(SYSDATE) BETWEEN PVA002_DATAINI AND PVA002_DATAFIM 
   
  AND NSA001_CANCELADA LIKE 'N' 
  AND TAA008_FATURAMENTO LIKE 'S' 
  AND PPA004_SEGMENTO NOT IN (21, 51) 
  AND ESP001_TPPLANEJAM NOT IN (4) 
  AND NSB001_QTDE > 0 
  AND PVB001_QTDEPREV = 0 
 
GROUP BY TO_CHAR(PVA002_DATAINI, 'RRRR'), TO_CHAR(PVA002_DATAINI, 'MM'), 
        PVA002_PRODUTO, PVA002_PRODUTOCONF, 
        CQFBA019(PVA002_GRUPO, PVA002_EMPRESA, PVA002_PRODUTO, PVA002_PRODUTOCONF), 
        PVA002_PERCENTUAL, PVB001_PRODUTO 
 
ORDER BY SEQUENCIA DESC 