SELECT PRODUTO, DESCRICAO, SEGMENTO 
 
FROM 
 
(SELECT DECODE(NSB001_PRODUTOCONF, 0, NSB001_PRODUTO, NSB001_PRODUTO||'-'||NSB001_PRODUTOCONF) PRODUTO, 
        NSB001_PRODDESC DESCRICAO, 
        STRING_AGG(DISTINCT TAA054_DESCRICAO) SEGMENTO 
         
FROM NSTBA001, NSTBB001, PPTBA004, TATBA008, TATBA054 
 
WHERE NSB001_GRUPO = NSA001_GRUPO 
  AND NSB001_EMPRESA = NSA001_EMPRESA 
  AND NSB001_FILIAL = NSA001_FILIAL 
  AND NSB001_TIPODOC = NSA001_TIPODOC 
  AND NSB001_NOTA = NSA001_NOTA 
  AND NSB001_SERIE = NSA001_SERIE 
   
  AND PPA004_GRUPO = NSA001_GRUPO 
  AND PPA004_EMPRESA = NSA001_EMPRESA 
  AND PPA004_PESSOA = NSA001_CLIENTE 
   
  AND TAA008_GRUPO = NSA001_GRUPO 
  AND TAA008_EMPRESA = NSA001_EMPRESA 
  AND TAA008_CONDICAO = NSA001_CONDICAO 
   
  AND TAA054_AREA = PPA004_AREA 
  AND TAA054_SEGMENTO = PPA004_SEGMENTO 
  AND TAA054_GRUPOPESSOA = PPA004_GRUPOPESSOA 
   
  AND NSA001_DTEMISSAO BETWEEN :PERIODO 
   
  AND NSA001_TIPODOC NOT IN ('NFSS') 
  AND NSA001_CANCELADA LIKE 'N' 
  AND TAA008_FATURAMENTO LIKE 'S' 
   
  AND PPA004_AREA = 1 
  AND PPA004_SEGMENTO NOT IN (21, 51, 61) 
   
GROUP BY NSB001_PRODUTO, NSB001_PRODUTOCONF, NSB001_PRODDESC) 
         
WHERE SEGMENTO LIKE '%,%' 
 
ORDER BY TO_CHAR(PRODUTO, 999999) 