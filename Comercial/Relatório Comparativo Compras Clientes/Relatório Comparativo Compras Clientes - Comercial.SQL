SELECT RANK() OVER(ORDER BY TO_CHAR(FATURAMENTO_ATUAL, 99999999) DESC, TO_CHAR(FATURAMENTO_ANTERIOR, 99999999) DESC)||'Â°' RANK,

    CLIENTE, DESCRICAO, CNPJ, SEGMENTO,

    FATURAMENTO_ATUAL, FATURAMENTO_ANTERIOR,

    FATURAMENTO_ATUAL - FATURAMENTO_ANTERIOR COMPARATIVO



FROM



(SELECT CLIENTE, DESCRICAO, CNPJ, SEGMENTO,

     

  NVL((SELECT SUM(NSA001_TOTALNOTA - NSA001_IMPOSTOS)

    FROM NSTBA001, PPTBA001, TATBA008

    WHERE PPA001_GRUPO = NSA001_GRUPO

     AND PPA001_EMPRESA = NSA001_EMPRESA

     AND PPA001_PESSOA = NSA001_CLIENTE

     AND TAA008_GRUPO = NSA001_GRUPO

     AND TAA008_EMPRESA = NSA001_EMPRESA

     AND TAA008_CONDICAO = NSA001_CONDICAO

     AND NSA001_CANCELADA LIKE 'N'

     AND TAA008_FATURAMENTO LIKE 'S'

     AND NSA001_CLIENTE = CLIENTE

     AND NSA001_DTEMISSAO BETWEEN :PERIODO), 0) FATURAMENTO_ATUAL,



  NVL((SELECT SUM(NSA001_TOTALNOTA - NSA001_IMPOSTOS)

    FROM NSTBA001, PPTBA001, TATBA008

    WHERE PPA001_GRUPO = NSA001_GRUPO

     AND PPA001_EMPRESA = NSA001_EMPRESA

     AND PPA001_PESSOA = NSA001_CLIENTE

     AND TAA008_GRUPO = NSA001_GRUPO

     AND TAA008_EMPRESA = NSA001_EMPRESA

     AND TAA008_CONDICAO = NSA001_CONDICAO

     AND NSA001_CANCELADA LIKE 'N'

     AND TAA008_FATURAMENTO LIKE 'S'

     AND NSA001_CLIENTE = CLIENTE

     AND NSA001_DTEMISSAO IN (SELECT TO_DATE(TO_CHAR(NSA001_DTEMISSAO, 'DD')||'/'||

                         TO_CHAR(NSA001_DTEMISSAO, 'MM')||'/'||

                         (TO_CHAR(NSA001_DTEMISSAO, 'RRRR') - 1)) DATAEMISSAO

                  FROM NSTBA001

                  WHERE NSA001_DTEMISSAO BETWEEN :PERIODO)), 0) FATURAMENTO_ANTERIOR



FROM



(SELECT PPA001_PESSOA CLIENTE,

    PPA001_NOME DESCRICAO,

    PPA001_CNPJ CNPJ,

    STRING_AGG(DISTINCT TAA054_DESCRICAO) SEGMENTO



FROM PPTBA001, PPTBA004, TATBA054



WHERE PPA004_PPA001_ID = PPA001_ID



 AND TAA054_GRUPO = PPA001_GRUPO

 AND TAA054_EMPRESA = PPA001_EMPRESA

 AND TAA054_AREA = PPA004_AREA

 AND TAA054_SEGMENTO = PPA004_SEGMENTO

 AND TAA054_GRUPOPESSOA = PPA004_GRUPOPESSOA



GROUP BY PPA001_PESSOA, PPA001_NOME, PPA001_CNPJ))



WHERE NOT(FATURAMENTO_ATUAL = 0 AND FATURAMENTO_ANTERIOR = 0)



ORDER BY TO_CHAR(FATURAMENTO_ATUAL, 99999999) DESC