SELECT  RANK() OVER(ORDER BY FATURAMENTO_ATUAL DESC, FATURAMENTO_ANTERIOR DESC) ||'Â°' RANK, 

        CLIENTE, DESCRICAO, CNPJ, PAIS, UF,  

         

        FATURAMENTO_ATUAL, 

         

        FATURAMENTO_ANTERIOR, 

         

        CASE  

            WHEN FATURAMENTO_ANTERIOR = 0 

            THEN NULL 

            ELSE ROUND(((FATURAMENTO_ATUAL * 100) / FATURAMENTO_ANTERIOR) - 100, 2)||'%' 

        END EVOLUCAO, 

         

        CASE 

            WHEN ((FATURAMENTO_ATUAL - FATURAMENTO_ANTERIOR) > 0) 

            THEN '<span class="badge badge-success" >'||TO_CHAR(FATURAMENTO_ATUAL - FATURAMENTO_ANTERIOR, 'L999G999G990D00')||'</span>' 

            WHEN (FATURAMENTO_ATUAL - FATURAMENTO_ANTERIOR < 0) 

            THEN '<span class="badge badge-danger" >'||TO_CHAR(FATURAMENTO_ATUAL - FATURAMENTO_ANTERIOR, 'L999G999G990D00')||'</span>' 

            ELSE '<span class="badge badge-warning" >'||TO_CHAR(FATURAMENTO_ATUAL - FATURAMENTO_ANTERIOR, 'L999G999G990D00')||'</span>' 

        END COMPARATIVO 

 

FROM 

 

(SELECT LISTAGEM.CLIENTE CLIENTE, LISTAGEM.DESCRICAO DESCRICAO, LISTAGEM.CNPJ CNPJ, LISTAGEM.PAIS PAIS, LISTAGEM.UF UF, 

         

   NVL((SELECT SUM(NSA001_TOTALNOTA - NSA001_IMPOSTOS) 

        FROM NSTBA001 

        JOIN PPTBA001 

          ON PPA001_GRUPO = NSA001_GRUPO 

         AND PPA001_EMPRESA = NSA001_EMPRESA 

         AND PPA001_PESSOA = NSA001_CLIENTE 

        JOIN TATBA008 

          ON TAA008_EMPRESA = NSA001_EMPRESA 

         AND TAA008_CONDICAO = NSA001_CONDICAO 

        WHERE NSA001_DTEMISSAO BETWEEN :PERIODO 

          AND NSA001_CANCELADA LIKE 'N' 

          AND TAA008_FATURAMENTO LIKE 'S' 

          AND NSA001_CLIENTE = LISTAGEM.CLIENTE), 0) FATURAMENTO_ATUAL, 

 

   NVL((SELECT SUM(NSA001_TOTALNOTA - NSA001_IMPOSTOS) 

        FROM NSTBA001 

        JOIN PPTBA001 

          ON PPA001_GRUPO = NSA001_GRUPO 

         AND PPA001_EMPRESA = NSA001_EMPRESA 

         AND PPA001_PESSOA = NSA001_CLIENTE 

        JOIN TATBA008 

          ON TAA008_EMPRESA = NSA001_EMPRESA 

         AND TAA008_CONDICAO = NSA001_CONDICAO 

        WHERE NSA001_DTEMISSAO IN (SELECT TO_DATE(NSA001_DTEMISSAO - 365) 

                                   FROM NSTBA001 

                                   WHERE NSA001_DTEMISSAO BETWEEN :PERIODO) 

          AND NSA001_CANCELADA LIKE 'N' 

          AND TAA008_FATURAMENTO LIKE 'S' 

          AND NSA001_CLIENTE = LISTAGEM.CLIENTE), 0) FATURAMENTO_ANTERIOR 

 

FROM 

 

(SELECT PPA001_PESSOA CLIENTE, 

        PPA001_NOME DESCRICAO, 

        PPA001_CNPJ CNPJ, 

        PPA001_PAIS PAIS, 

        PPA001_UF UF 

 

FROM PPTBA001 

 

JOIN PPTBA004 

  ON PPA004_PPA001_ID = PPA001_ID 

   

JOIN CLTBA001 

  ON CLA001_ID = PPA001_ID 

 

JOIN TATBA054  

  ON TAA054_GRUPO = PPA001_GRUPO 

 AND TAA054_EMPRESA = PPA001_EMPRESA 

 AND TAA054_AREA = PPA004_AREA 

 AND TAA054_SEGMENTO = PPA004_SEGMENTO 

 AND TAA054_GRUPOPESSOA = PPA004_GRUPOPESSOA 

 

WHERE CLA001_CLIDESDE BETWEEN NVL(:DATACLIENTE, '01/01/1000') AND SYSDATE 

  AND PPA004_GRUPOPESSOA :SEGMENTO 

  AND PPA004_SUBGRUPO :SUBGRUPO  

 

GROUP BY PPA001_PESSOA, PPA001_NOME, PPA001_CNPJ, PPA001_PAIS, PPA001_UF) LISTAGEM) 

 

WHERE NOT(FATURAMENTO_ATUAL = 0 AND FATURAMENTO_ANTERIOR = 0) 