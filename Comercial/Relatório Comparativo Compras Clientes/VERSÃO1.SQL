SELECT RANK() OVER(ORDER BY FATURAMENTO_ATUAL DESC)||'Â°' RANK, 
        CLIENTE CLIENTE, 
        DESCRICAO DESCRICAO, 
        CNPJ CNPJ, 
        SEGMENTO SEGMENTO, 
        FATURAMENTO_ATUAL FATURAMENTO_ATUAL, 
        FATURAMENTO_ANTERIOR FATURAMENTO_ANTERIOR 
 
FROM 
 
(SELECT CORE.CLIENTE, 
        CORE.DESCRICAO, 
        CORE.CNPJ, 
        CORE.SEGMENTO, 
         
  NVL((SELECT SUM(NSA001_TOTALNOTA) 
     
        FROM NSTBA001, PPTBA001, PPTBA004, TATBA008 
         
        WHERE PPA001_GRUPO = NSA001_GRUPO 
        AND PPA001_EMPRESA = NSA001_EMPRESA 
        AND PPA001_PESSOA = NSA001_CLIENTE 
         
        AND PPA004_PPA001_ID = PPA001_ID 
        AND PPA004_GRUPO = NSA001_GRUPO 
        AND PPA004_EMPRESA = NSA001_EMPRESA 
        AND PPA004_PESSOA = NSA001_CLIENTE 
         
        AND TAA008_GRUPO = NSA001_GRUPO 
        AND TAA008_EMPRESA = NSA001_EMPRESA 
        AND TAA008_CONDICAO = NSA001_CONDICAO 
         
        AND NSA001_CANCELADA LIKE 'N' 
        AND TAA008_FATURAMENTO LIKE 'S' 
        AND PPA004_SEGMENTO IN (11, 12, 999) 
                   
        AND NSA001_CLIENTE = CORE.CLIENTE 
        AND TO_CHAR(NSA001_DTEMISSAO, 'RRRR') = :ANO  
        AND TO_CHAR(NSA001_DTEMISSAO, 'MM') = :MES), 0) FATURAMENTO_ATUAL, 
         
   NVL((SELECT SUM(NSA001_TOTALNOTA) 
     
        FROM NSTBA001, PPTBA001, PPTBA004, TATBA008 
         
        WHERE PPA001_GRUPO = NSA001_GRUPO 
        AND PPA001_EMPRESA = NSA001_EMPRESA 
        AND PPA001_PESSOA = NSA001_CLIENTE 
         
        AND PPA004_PPA001_ID = PPA001_ID 
        AND PPA004_GRUPO = NSA001_GRUPO 
        AND PPA004_EMPRESA = NSA001_EMPRESA 
        AND PPA004_PESSOA = NSA001_CLIENTE 
         
        AND TAA008_GRUPO = NSA001_GRUPO 
        AND TAA008_EMPRESA = NSA001_EMPRESA 
        AND TAA008_CONDICAO = NSA001_CONDICAO 
         
        AND NSA001_CANCELADA LIKE 'N' 
        AND TAA008_FATURAMENTO LIKE 'S' 
        AND PPA004_SEGMENTO IN (11, 12, 999) 
                   
        AND NSA001_CLIENTE = CORE.CLIENTE 
        AND TO_CHAR(NSA001_DTEMISSAO, 'RRRR') = PERIODO_ANTERIOR.ANO  
        AND TO_CHAR(NSA001_DTEMISSAO, 'MM') = PERIODO_ANTERIOR.MES), 0) FATURAMENTO_ANTERIOR 
 
FROM 
 
(SELECT PPA001_PESSOA CLIENTE, 
        PPA001_NOME DESCRICAO, 
        PPA001_CNPJ CNPJ, 
        TAA054_DESCRICAO SEGMENTO 
 
FROM PPTBA001, PPTBA004, TATBA054 
 
WHERE PPA004_PPA001_ID = PPA001_ID 
  AND PPA004_GRUPO = PPA001_GRUPO 
  AND PPA004_EMPRESA = PPA001_EMPRESA 
  AND PPA004_PESSOA = PPA001_PESSOA 
   
  AND TAA054_GRUPO = PPA001_GRUPO 
  AND TAA054_EMPRESA = PPA001_EMPRESA 
  AND TAA054_AREA = PPA004_AREA 
  AND TAA054_SEGMENTO = PPA004_SEGMENTO 
  AND TAA054_GRUPOPESSOA = PPA004_GRUPOPESSOA 
   
  AND PPA004_SEGMENTO IN (11, 12, 999)) CORE, 
   
(SELECT MES, 
        ANO 
FROM 
(SELECT EXTRACT (MONTH FROM (NSA001_DTEMISSAO - 31)) MES, 
        EXTRACT (YEAR FROM (NSA001_DTEMISSAO - 31)) ANO 
FROM NSTBA001 
WHERE TO_CHAR(NSA001_DTEMISSAO, 'RRRR') = :ANO 
  AND TO_CHAR(NSA001_DTEMISSAO, 'MM') = :MES) 
 
GROUP BY MES, 
        ANO) PERIODO_ANTERIOR) 
 
WHERE NOT(FATURAMENTO_ATUAL = 0 AND FATURAMENTO_ANTERIOR = 0) 
 
ORDER BY FATURAMENTO_ATUAL DESC 