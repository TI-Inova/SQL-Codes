SELECT  CORE.TIPODOC TIPODOC, 
        PEA005_OBSERVACAO OBS, 
        COUNT(CORE.PEDIDO) PEDIDO, 
        SUM(CORE.QTD) QTD 
 
FROM PETBA005, 
 
(SELECT PEB002_TIPODOC TIPODOC, 
        PEB002_PEDIDO PEDIDO, 
        PEB002_DOCUMENTO DOC, 
        SUM(PEB002_QTDEATEND + PEB002_QTDECANC) QTD 
 
FROM PETBB002 
WHERE PEB002_TIPODOC IN ('PV','PVEXP','CONSER','GARANT','PSERV','REMCON','PDEM','PVCOEX','AMSEXP','PVBON') 
  AND PEB002_DOCUMENTO NOT IN ('CAN') 
  AND PEB002_DATAATEND BETWEEN :DATAINI AND :DATAFIN 
 
GROUP BY PEB002_TIPODOC, PEB002_PEDIDO, PEB002_DOCUMENTO 
 
UNION 
 
SELECT PEB002_TIPODOC TIPODOC, 
        PEB002_PEDIDO PEDIDO, 
        PEB002_DOCUMENTO DOC, 
        SUM(PEB002_QTDEATEND + PEB002_QTDECANC) QTD 
 
FROM PETBB002 
 
WHERE PEB002_TIPODOC IN ('PINOVA') 
  AND PEB002_DATAATEND BETWEEN :DATAINI AND :DATAFIN 
 
GROUP BY PEB002_TIPODOC, PEB002_PEDIDO, PEB002_DOCUMENTO)) CORE 
 
WHERE PEA005_PEDIDO = CORE.PEDIDO 
  AND PEA005_TIPODOC = CORE.TIPODOC 
  AND PEA005_CODOBS IN (1256, 1257) 
 
GROUP BY CORE.TIPODOC, PEA005_OBSERVACAO        
 
UNION 
 
SELECT  CORE.TIPODOC TIPODOC, 
        'SEM OBSERVAÇÃO' OBS, 
        COUNT(CORE.PEDIDO) PEDIDO, 
        SUM(CORE.QTD) QTD 
 
FROM 
 
(SELECT PEB002_TIPODOC TIPODOC, 
        PEB002_PEDIDO PEDIDO, 
        PEB002_DOCUMENTO DOC, 
        SUM(PEB002_QTDEATEND + PEB002_QTDECANC) QTD 
 
FROM PETBB002 
 
WHERE PEB002_TIPODOC IN ('PV','PVEXP','CONSER','GARANT','PSERV','REMCON','PDEM','PVCOEX','AMSEXP','PVBON') 
  AND PEB002_DOCUMENTO NOT IN ('CAN') 
  AND PEB002_DATAATEND BETWEEN :DATAINI AND :DATAFIN 
 
GROUP BY PEB002_TIPODOC, PEB002_PEDIDO, PEB002_DOCUMENTO 
 
UNION 
 
SELECT PEB002_TIPODOC TIPODOC, 
        PEB002_PEDIDO PEDIDO, 
        PEB002_DOCUMENTO DOC, 
        SUM(PEB002_QTDEATEND + PEB002_QTDECANC) QTD 
 
FROM PETBB002 
 
WHERE PEB002_TIPODOC IN ('PINOVA') 
  AND PEB002_DATAATEND BETWEEN :DATAINI AND :DATAFIN 
 
GROUP BY PEB002_TIPODOC, PEB002_PEDIDO, PEB002_DOCUMENTO)) CORE 
 
WHERE CORE.PEDIDO NOT IN (SELECT CORE.PEDIDO 
                                FROM PETBA005, 
                                (SELECT PEB002_TIPODOC TIPODOC, 
                                 PEB002_PEDIDO PEDIDO, 
                                 PEB002_DOCUMENTO DOC, 
                                 SUM(PEB002_QTDEATEND + PEB002_QTDECANC) QTD 
                          FROM PETBB002 
                          WHERE PEB002_TIPODOC IN ('PV','PVEXP','CONSER','GARANT','PSERV','REMCON','PDEM','PVCOEX','AMSEXP','PVBON') 
                            AND PEB002_DOCUMENTO NOT IN ('CAN') 
                            AND PEB002_DATAATEND BETWEEN :DATAINI AND :DATAFIN 
                          GROUP BY PEB002_TIPODOC, PEB002_PEDIDO, PEB002_DOCUMENTO 
 
                          UNION 
 
                          SELECT PEB002_TIPODOC TIPODOC, 
                                 PEB002_PEDIDO PEDIDO, 
                                 PEB002_DOCUMENTO DOC, 
                                 SUM(PEB002_QTDEATEND + PEB002_QTDECANC) QTD 
 
                           FROM PETBB002 
                           WHERE PEB002_TIPODOC IN ('PINOVA') 
                             AND PEB002_DATAATEND BETWEEN :DATAINI AND :DATAFIN 
                           GROUP BY PEB002_TIPODOC, PEB002_PEDIDO, PEB002_DOCUMENTO)) CORE 
 
WHERE PEA005_PEDIDO = CORE.PEDIDO 
  AND PEA005_TIPODOC = CORE.TIPODOC 
  AND PEA005_CODOBS IN (1256, 1257)) 
 
GROUP BY CORE.TIPODOC, 'SEM OBSERVAÇÃO') 
 
UNION 
 
SELECT 'ASSIST' TIPODOC, 
        'SEM OBSERVAÇÃO' OBS, 
        COUNT(DISTINCT NSA001_NOTA) PEDIDO, 
        SUM(NSB001_QTDE) QTD 
 
FROM NSTBA001, NSTBB001 
 
WHERE NSA001_DTEMISSAO BETWEEN :DATAINI AND :DATAFIN 
  AND NSB001_NOTA = NSA001_NOTA 
  AND NSB001_TIPODOC = NSA001_TIPODOC 
  AND NSA001_TIPODOC LIKE 'NFS' 
  AND NSB001_NATUREZA IN ('5916', '6916', '6949') 
  AND NSB001_OPERACAO NOT IN ('6958') 
 
GROUP BY 'ASSIST', NSA001_TIPODOC)