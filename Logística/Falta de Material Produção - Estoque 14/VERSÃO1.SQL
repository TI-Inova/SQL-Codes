SELECT * 
FROM 
(SELECT STRING_AGG(DISTINCT CORE.RECURSO) RECURSOS, 
        DECODE(CORE.COMPONENTECONF, 0, CORE.COMPONENTE, CORE.COMPONENTE||'-'||CORE.COMPONENTECONF) COMPONENTE, 
        CORE.DESCRICAO DESCRICAO, 
        CORE.UM UM, 
        SUM(CORE.DEMANDA) DEMANDA, 
        CORE.ESTOQUE ESTOQUE, 
        (CORE.ESTOQUE - SUM(CORE.DEMANDA)) SALDO, 
        CORE.ALMOXDEST ALMOXDEST, 
        CORE.DISPONIBILIDADE DISPONIBILIDADE, 
        CORE.LOCAL LOCAL, 
        CASE WHEN (CORE.ESTOQUE - SUM(CORE.DEMANDA)) < 0 THEN 'SEPARAR' ELSE ' ' END SEPARAR 
FROM 
(SELECT OPS012_RECURSO RECURSO, 
        OPS012_DATASIMUL DATASIMUL, 
        MAX(OPS012_VERSAO) VERSAO, 
        OPS012_TIPODOC TIPODOC, 
        OPS012_ORDEM ORDEM, 
        OPS012_PRODUTO PRODUTO, 
        OPS012_PRODUTOCONF PRODUTOCONF, 
        RMC001_PRODUTO COMPONENTE, 
        RMC001_PRODUTOCONF COMPONENTECONF, 
        CQFBA019(RMC001_GRUPO, RMC001_EMPRESA, RMC001_PRODUTO, RMC001_PRODUTOCONF) DESCRICAO, 
        RMC001_UM UM, 
        (RMC001_QTDESOL - RMC001_QTDECAN) DEMANDA, 
        ESPGA002.ESFPA002003(RMC001_GRUPO, RMC001_EMPRESA, RMC001_FILIAL, RMC001_PRODUTO, RMC001_PRODUTOCONF, RMC001_AXDESTINO) ESTOQUE, 
        ESPGA002.ESFPA002003(RMC001_GRUPO, RMC001_EMPRESA, RMC001_FILIAL, RMC001_PRODUTO, RMC001_PRODUTOCONF, 1) 
        +ESPGA002.ESFPA002003(RMC001_GRUPO, RMC001_EMPRESA, RMC001_FILIAL, RMC001_PRODUTO, RMC001_PRODUTOCONF, 13) 
        +ESPGA002.ESFPA002003(RMC001_GRUPO, RMC001_EMPRESA, RMC001_FILIAL, RMC001_PRODUTO, RMC001_PRODUTOCONF, 43) DISPONIBILIDADE, 
        ESFBI001(RMC001_GRUPO, RMC001_EMPRESA, RMC001_FILIAL, RMC001_PRODUTO, RMC001_PRODUTOCONF) LOCAL, 
        RMC001_AXDESTINO ALMOXDEST 
FROM OPTBS011, OPTBS012, RMTBC001 
WHERE OPS011_ID = OPS012_OPS011_ID   
  AND RMC001_TIPODOCOP = OPS012_TIPODOC 
  AND RMC001_ORDEM = OPS012_ORDEM 
  AND RMC001_FILIAL = OPS012_FILIAL 
  AND OPS012_DATASIMUL BETWEEN NVL(:DATAINI, SYSDATE+1) AND NVL(:DATAFIM, SYSDATE+1)   
  AND RMC001_AXDESTINO = 14 
  AND OPS012_RECURSO NOT IN (21, 45, 50, 81, 91, 93) 
  AND RMC001_SITUACAO = 1 
  AND OPS011_STATUS = 2 
GROUP BY RMC001_GRUPO, RMC001_EMPRESA, RMC001_FILIAL, 
        OPS012_RECURSO, OPS012_DATASIMUL, 
        OPS012_TIPODOC, OPS012_ORDEM, 
        OPS012_PRODUTO, OPS012_PRODUTOCONF, 
        RMC001_PRODUTO, RMC001_PRODUTOCONF, RMC001_UM, 
        RMC001_QTDESOL, RMC001_QTDECAN, 
        RMC001_AXDESTINO) CORE 
         
WHERE CORE.RECURSO = :RECURSO 
GROUP BY CORE.COMPONENTE, 
        CORE.COMPONENTECONF, 
        CORE.DESCRICAO, 
        CORE.UM, 
        CORE.ESTOQUE, 
        CORE.ALMOXDEST, 
        CORE.DISPONIBILIDADE, 
        CORE.LOCAL) 
WHERE SEPARAR LIKE NVL(:SEPARAR,'%') 
