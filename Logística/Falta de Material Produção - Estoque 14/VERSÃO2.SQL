SELECT * FROM 
 
(SELECT STRING_AGG(DISTINCT OPS012_RECURSO) RECURSO, 
        DECODE(RMC001_PRODUTOCONF, 0, RMC001_PRODUTO, RMC001_PRODUTO||'-'||RMC001_PRODUTOCONF) COMPONENTE, 
         
        CQFBA019(RMC001_GRUPO, RMC001_EMPRESA, RMC001_PRODUTO, RMC001_PRODUTOCONF) DESCRICAO, 
         
        RMC001_UM UM, 
         
        SUM(RMC001_QTDESOL - RMC001_QTDECAN) DEMANDA, 
         
        ESPGA002.ESFPA002003(RMC001_GRUPO, RMC001_EMPRESA, RMC001_FILIAL, RMC001_PRODUTO, RMC001_PRODUTOCONF, RMC001_AXDESTINO) ESTOQUE, 
         
        ESPGA002.ESFPA002003(RMC001_GRUPO, RMC001_EMPRESA, RMC001_FILIAL, RMC001_PRODUTO, RMC001_PRODUTOCONF, RMC001_AXDESTINO) - 
        SUM(RMC001_QTDESOL - RMC001_QTDECAN) SALDO, 
         
        ESPGA002.ESFPA002003(RMC001_GRUPO, RMC001_EMPRESA, RMC001_FILIAL, RMC001_PRODUTO, RMC001_PRODUTOCONF, 1) + 
        ESPGA002.ESFPA002003(RMC001_GRUPO, RMC001_EMPRESA, RMC001_FILIAL, RMC001_PRODUTO, RMC001_PRODUTOCONF, 13) + 
        ESPGA002.ESFPA002003(RMC001_GRUPO, RMC001_EMPRESA, RMC001_FILIAL, RMC001_PRODUTO, RMC001_PRODUTOCONF, 43) DISPONIBILIDADE, 
         
        RMC001_AXDESTINO ALMOXDEST, 
         
        ESFBI001(RMC001_GRUPO, RMC001_EMPRESA, RMC001_FILIAL, RMC001_PRODUTO, RMC001_PRODUTOCONF) LOCAL, 
         
        OPS012_DATASIMUL  DATASIMUL, 
         
        CASE 
            WHEN (ESPGA002.ESFPA002003(RMC001_GRUPO, RMC001_EMPRESA, RMC001_FILIAL, RMC001_PRODUTO, RMC001_PRODUTOCONF, RMC001_AXDESTINO) -  
                  SUM(RMC001_QTDESOL - RMC001_QTDECAN)) < 0 
            THEN 'SEPARAR' 
            ELSE ' '  
        END SEPARAR 
 
FROM RMTBC001, OPTBS011, OPTBS012 
 
WHERE OPS012_OPS011_ID = OPS011_ID 
 
  AND OPS012_GRUPO = RMC001_GRUPO 
  AND OPS012_EMPRESA = RMC001_EMPRESA 
  AND OPS012_FILIAL = RMC001_FILIAL 
  AND OPS012_TIPODOC = RMC001_TIPODOCOP 
  AND OPS012_ORDEM = RMC001_ORDEM 
  AND OPS012_LINHA = RMC001_LINHAOP 
   
  AND OPS012_DATASIMUL BETWEEN :PERIODO 
   
  AND OPS012_RECURSO :RECURSO 
   
  AND OPS012_RECURSO NOT IN (21, 45, 50, 81, 91, 93) 
  AND RMC001_AXDESTINO = 14 
  AND RMC001_SITUACAO = 1 
  AND OPS011_STATUS = 2 
 
GROUP BY RMC001_GRUPO, RMC001_EMPRESA, RMC001_FILIAL, 
        RMC001_PRODUTO, RMC001_PRODUTOCONF, RMC001_UM, 
        RMC001_AXDESTINO, OPS012_DATASIMUL) 
 
WHERE SEPARAR LIKE NVL(:SEPARAR,'%') 
 
UNION 
 
SELECT TO_CHAR(SYSDATE, 'DD/MM/RRRR') RECURSO, TO_CHAR(SYSDATE, 'HH24:MI') COMPONENTE, NULL DESCRICAO, NULL UM, NULL DEMANDA, NULL ESTOQUE, NULL SALDO, NULL DISPONIBILIDADE, NULL ALMOXDEST, NULL LOCAL, NULL DATASIMUL, NULL SEPARAR 
 
FROM DUAL 