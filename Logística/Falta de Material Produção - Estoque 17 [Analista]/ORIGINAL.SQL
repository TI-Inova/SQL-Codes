SELECT PRODUTO, 
       DESCRICAO, 
       TO_CHAR(QTDERANCHO,'FM999G999G999G990D00') QTDERANCHO, 
       SALDO, 
       TO_CHAR(DECODE(SIGN(QTDETRANSF),-1,0,QTDETRANSF),'FM999G999G999G990D00') QTDETRANSF, 
       AVISO, 
       LOCAL, 
       COD_GAP 
FROM(SELECT PRODUTO, 
            DESCRICAO, 
            QTDERANCHO, 
            TO_CHAR(SALDO,'FM999G999G999G990D00') SALDO, 
            (QTDERANCHO-SALDO) QTDETRANSF, 
            CASE WHEN QTDERANCHO > SALDO 
                 THEN 'SEPARAR' 
                 ELSE ' ' 
                 END AVISO, 
            LOCAL, 
            COD_GAP       
     FROM(SELECT DECODE(RMC001_PRODUTOCONF,0,RMC001_PRODUTO,RMC001_PRODUTO||'-'||RMC001_PRODUTOCONF) PRODUTO, 
                 CQFBA019(RMC001_GRUPO,RMC001_EMPRESA,RMC001_PRODUTO,RMC001_PRODUTOCONF) DESCRICAO, 
                 SUM(RMC001_QTDESOL - RMC001_QTDEATE - RMC001_QTDECAN) QTDERANCHO, 
                 ESPGA002.ESFPA002003(RMC001_GRUPO,RMC001_EMPRESA,RMC001_FILIAL,RMC001_PRODUTO,RMC001_PRODUTOCONF,RMC001_AXDESTINO) SALDO, 
                 ESFBI001(RMC001_GRUPO,RMC001_EMPRESA,RMC001_FILIAL,RMC001_PRODUTO,RMC001_PRODUTOCONF) LOCAL, 
                 (SELECT MAX(FOC001_CODPRODUTO) 
                  FROM FOTBC001 
                  WHERE FOC001_FORNECEDOR = '2266' 
                  AND FOC001_PRODUTO      = RMC001_PRODUTO 
                  AND FOC001_PRODUTOCONF  = RMC001_PRODUTOCONF) COD_GAP 
          FROM RMTBC001 
          WHERE RMC001_GRUPO = 1 
          AND RMC001_EMPRESA = 1 
          AND RMC001_FILIAL  = :FILIAL 
          AND TO_CHAR(RMC001_AXDESTINO) LIKE NVL(:ALMOX,'%') 
          AND RMC001_SITUACAO  = 1 
          AND EXISTS (SELECT 1 
                      FROM OPTBS012,OPTBS011 
                      WHERE OPS012_GRUPO   = RMC001_GRUPO 
                      AND OPS012_EMPRESA   = RMC001_EMPRESA 
                      AND OPS012_FILIAL    = RMC001_FILIAL 
                      AND OPS012_TIPODOC   = RMC001_TIPODOCOP 
                      AND OPS012_ORDEM     = RMC001_ORDEM 
                      AND OPS012_LINHA     = RMC001_LINHAOP 
                      AND OPS012_DATASIMUL BETWEEN NVL(:DATAINI,TRUNC(SYSDATE)) AND NVL(:DATAFIM,TRUNC(SYSDATE)) 
                      AND OPS012_OPS011_ID = OPS011_ID 
                      AND TO_CHAR(OPS012_RECURSO) LIKE NVL(:RECURSO,'%') 
                      AND OPS011_STATUS    = 2) 
                     /* AND EXISTS (SELECT 1 
                                  FROM ESTBA008 
                                  WHERE RMC001_GRUPO = ESA008_GRUPO 
                                  AND RMC001_EMPRESA = ESA008_EMPRESA 
                                  AND RMC001_PRODUTO = ESA008_PRODUTO 
                                  AND ESA008_AREA    = 2 
                                  AND ESA008_FAMILIA = FAMILIA 
                                  AND ESA008_GRUPOPROD = GRUPO)*/ 
GROUP BY RMC001_GRUPO,RMC001_EMPRESA,RMC001_FILIAL,RMC001_PRODUTO,RMC001_PRODUTOCONF,RMC001_AXDESTINO) 
ORDER BY PRODUTO) 
WHERE AVISO LIKE :AVISO  