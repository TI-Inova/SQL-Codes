SELECT OCA001_TIPODOC ||' - '|| OCA001_ORDCOMPRA AS ORDEM,
       OCA001_FORNECEDOR ||' - '|| PPA001_NOME AS FORNECEDOR,
       OCA001_CONDICAO ||' - '|| TAA008_DESCRICAO AS CONDICAO,
       OCB001_LINHA AS LINHAPED,
       OCB001_DTENTREGAPREV AS DATAPREV,
       OCA010_LOCALEMBARQUE AS LOCAL_EMBARQUE,
       MAX(OCA011_PARCELA) AS PARCELAS,
       OCA011_VALOR AS VALOR,

CASE 
    WHEN MAX(OCA011_PARCELA) = 0 THEN 1 -- Condição especial: Parcela 0
    WHEN MAX(OCA011_PARCELA) = 1 AND OCA011_VALOR IS NOT NULL THEN 2 -- Parcela 1
    WHEN MAX(OCA011_PARCELA) = 2 AND OCA011_VALOR IS NOT NULL THEN 2 -- Parcela 2
    WHEN MAX(OCA011_PARCELA) = 3 AND OCA011_VALOR IS NOT NULL THEN 3 -- Parcela 3
    WHEN MAX(OCA011_PARCELA) = 4 AND OCA011_VALOR IS NOT NULL THEN 4 -- Parcela 4
    WHEN MAX(OCA011_PARCELA) IS NOT NULL AND OCA011_VALOR IS NOT NULL THEN 1 -- Outras condições com valor
    ELSE 0 -- Outras condições sem valor
    END AS PARCELA_CONDICAO_ANTECIPADA
     
FROM OCTBA001

JOIN OCTBA010 ON OCA001_GRUPO = OCA010_GRUPO
 AND OCA001_EMPRESA = OCA010_EMPRESA
 AND OCA001_FILIAL = OCA010_FILIAL
 AND OCA001_TIPODOC = OCA010_TIPODOC
 AND OCA001_ORDCOMPRA = OCA010_ORDCOMPRA
 
LEFT JOIN OCTBB001 ON OCB001_GRUPO = OCA001_GRUPO
      AND OCB001_EMPRESA = OCA001_EMPRESA
      AND OCB001_FILIAL = OCA001_FILIAL
      AND OCB001_TIPODOC = OCA001_TIPODOC
      AND OCB001_ORDCOMPRA = OCA001_ORDCOMPRA

LEFT JOIN OCTBA011 ON OCA011_GRUPO = OCA001_GRUPO
      AND OCA011_EMPRESA = OCA001_EMPRESA
      AND OCA011_FILIAL = OCA001_FILIAL
      AND OCA011_TIPODOC = OCA001_TIPODOC
      AND OCA011_ORDCOMPRA = OCA001_ORDCOMPRA

LEFT JOIN PPTBA001 ON PPA001_GRUPO = OCA001_GRUPO
      AND PPA001_EMPRESA = OCA001_EMPRESA
      AND PPA001_PESSOA = OCA001_FORNECEDOR

LEFT JOIN TATBA008 ON TAA008_GRUPO = OCA001_GRUPO
      AND TAA008_EMPRESA = OCA001_EMPRESA
      AND TAA008_CONDICAO = OCA001_CONDICAO
      
WHERE EXISTS (SELECT 1
                FROM TATBA008
               WHERE TAA008_GRUPO = OCA001_GRUPO
                 AND TAA008_EMPRESA = OCA001_EMPRESA
                 AND TAA008_CONDICAO = OCA001_CONDICAO)

AND EXISTS (SELECT 1
              FROM PPTBA001
             WHERE PPA001_GRUPO = OCA001_GRUPO
               AND PPA001_EMPRESA = OCA001_EMPRESA
               AND PPA001_PESSOA = OCA001_FORNECEDOR)

--FILTROS
AND OCA001_SITUACAO = 1
AND OCA001_TIPODOC IN ('OCIMP')
AND OCA001_CONDICAO IN (343, 354, 355, 356, 357)
--AND OCA010_LOCALEMBARQUE IS NULL

--AGRUPADOR 
GROUP BY OCA001_TIPODOC ||' - '|| OCA001_ORDCOMPRA,
         OCA001_FORNECEDOR,
         PPA001_NOME,
         OCA001_CONDICAO,
         TAA008_DESCRICAO,
         OCB001_LINHA,
         OCB001_DTENTREGAPREV,
         OCA010_LOCALEMBARQUE,
         OCA011_VALOR

UNION

SELECT OCA001_TIPODOC ||' - '|| OCA001_ORDCOMPRA AS ORDEM,
       OCA001_FORNECEDOR ||' - '|| PPA001_NOME AS FORNECEDOR,
       OCA001_CONDICAO ||' - '|| TAA008_DESCRICAO AS CONDICAO,
       NULL AS LINHAPED,
       NULL AS DATAPREV,
       NULL AS LOCAL_EMBARQUE,
       NULL AS PARCELAS,
       NULL AS VALOR,
       NULL AS PARCELA_CONDICAO_ANTECIPADA

FROM OCTBA001, PPTBA001, TATBA008

WHERE NOT EXISTS (SELECT NULL
                         FROM OCTBA010
                        WHERE OCA010_GRUPO = OCA001_GRUPO
                          AND OCA010_EMPRESA = OCA001_EMPRESA
                          AND OCA010_FILIAL = OCA001_FILIAL
                          AND OCA010_TIPODOC = OCA001_TIPODOC
                          AND OCA010_ORDCOMPRA = OCA001_ORDCOMPRA)

AND PPA001_GRUPO = OCA001_GRUPO
AND PPA001_EMPRESA = OCA001_EMPRESA
AND PPA001_PESSOA = OCA001_FORNECEDOR

AND TAA008_GRUPO = OCA001_GRUPO
AND TAA008_EMPRESA = OCA001_EMPRESA
AND TAA008_CONDICAO = OCA001_CONDICAO
 
AND OCA001_CONDICAO IN (343, 354, 355, 356, 357)
AND OCA001_SITUACAO = 1
AND OCA001_TIPODOC = 'OCIMP'
AND OCA001_ORDCOMPRA BETWEEN 4750 AND 4800 

ORDER BY ORDEM, FORNECEDOR, LINHAPED;