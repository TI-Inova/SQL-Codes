SELECT ESA001_PRODUTO PRODUTO, 
       ESA001_DESCRICAO DESCRICAO, 
       espga002.ESFPA002026(ESA001_GRUPO,ESA001_EMPRESA,ESA001_PRODUTO,0,NULL) ESTOQUE, 
       espga002.ESFPA002027(ESA001_GRUPO,ESA001_EMPRESA,ESA001_PRODUTO,0,:DTINI,3,'L,P,F')DEMANDA, 
      (espga002.ESFPA002026(ESA001_GRUPO,ESA001_EMPRESA,ESA001_PRODUTO,0,NULL) - 

       espga002.ESFPA002027(ESA001_GRUPO,ESA001_EMPRESA,ESA001_PRODUTO,0,(SYSDATE -1),3,'L,P,F')) SALDO, 
      (SELECT SUM(OCB001_QTDEABE) 
             FROM OCTBB001 
            WHERE OCB001_GRUPO = ESA001_GRUPO 
              AND OCB001_EMPRESA = ESA001_EMPRESA 
              AND OCB001_PRODUTO = ESA001_PRODUTO 
              AND OCB001_SITUACAO = 1) QTDEOC, 
       (SELECT MIN(OCB001_DTENTREGASOL)||' '||MIN(OCB001_TIPODOC)||'-'||MIN(OCB001_ORDCOMPRA) 
              FROM OCTBB001 
             WHERE OCB001_GRUPO = ESA001_GRUPO 
              AND OCB001_EMPRESA = ESA001_EMPRESA 
              AND OCB001_PRODUTO = ESA001_PRODUTO 
              AND OCB001_SITUACAO = 1) DTPROX 
FROM ESTBA001 
WHERE ESA001_GRUPO = 1 
AND ESA001_EMPRESA = 1 
AND ESA001_PRODUTO LIKE NVL(:PRODUTO,'%') 
AND ESA001_GRUPOPLAN = :ORIGEM 
AND (espga002.ESFPA002027(ESA001_GRUPO,ESA001_EMPRESA,ESA001_PRODUTO,0,(SYSDATE -1),3,'L,P,F')) > 

    (espga002.ESFPA002026(ESA001_GRUPO,ESA001_EMPRESA,ESA001_PRODUTO,0,NULL)) 
AND EXISTS (SELECT 1 
              FROM ESTBA008 
             WHERE ESA001_GRUPO = ESA008_GRUPO 
             AND ESA001_EMPRESA = ESA008_EMPRESA 
             AND ESA001_PRODUTO = ESA008_PRODUTO 
             AND ESA008_AREA = 2 
             AND ESA008_FAMILIA IN (21,30))  