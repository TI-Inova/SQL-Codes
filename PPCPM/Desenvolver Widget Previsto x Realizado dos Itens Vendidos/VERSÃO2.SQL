SELECT  MES||'/'||ANO PERIODO, 

        DECODE(PRODUTOCONF, 0, PRODUTO, PRODUTO||'-'||PRODUTOCONF) PRODUTO, 

        DESCRICAO, 

        SEGMENTO, 

        QTD_PREV, 

        QTD_VEND, 

        ROUND(((QTD_VEND / QTD_PREV) * 100) - 100, 1) MARGEM, 

        TO_CHAR(PRODUTO, 99999999)||TO_CHAR(1000, 99999999) SEQUENCIA 

 

FROM 

 

(SELECT * FROM 

 

(SELECT PVB001_PERIODO MES, 

        PVB001_ANO ANO, 

        PVB001_PRODUTO PRODUTO,  

        PVB001_PRODUTOCONF PRODUTOCONF, 

        CQFBA019(PVB001_GRUPO, PVB001_EMPRESA, PVB001_PRODUTO, PVB001_PRODUTOCONF) DESCRICAO, 

         

       (SELECT STRING_AGG(DISTINCT TAA054_DESCRICAO) 

        FROM NSTBA001 

        JOIN NSTBB001 

          ON NSB001_GRUPO = NSA001_GRUPO 

         AND NSB001_EMPRESA = NSA001_EMPRESA 

         AND NSB001_FILIAL = NSA001_FILIAL 

         AND NSB001_TIPODOC = NSA001_TIPODOC 

         AND NSB001_NOTA = NSA001_NOTA 

         AND NSB001_SERIE = NSA001_SERIE     

        JOIN PPTBA004 

          ON PPA004_GRUPO = NSA001_GRUPO 

         AND PPA004_EMPRESA = NSA001_EMPRESA 

         AND PPA004_PESSOA = NSA001_CLIENTE   

        JOIN TATBA008 

          ON TAA008_GRUPO = NSA001_GRUPO 

         AND TAA008_EMPRESA = NSA001_EMPRESA 

         AND TAA008_CONDICAO = NSA001_CONDICAO   

        JOIN TATBA054 

          ON TAA054_GRUPO = NSA001_GRUPO 

         AND TAA054_EMPRESA = NSA001_EMPRESA 

         AND TAA054_SEGMENTO = PPA004_SEGMENTO 

         AND TAA054_GRUPOPESSOA = PPA004_GRUPOPESSOA  

        WHERE TO_CHAR(NSA001_DTEMISSAO, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY') 

          AND TO_CHAR(NSA001_DTEMISSAO, 'MM') = TO_CHAR(SYSDATE, 'MM') 

          AND NSA001_CANCELADA LIKE 'N' 

          AND TAA008_FATURAMENTO LIKE 'S' 

          AND PPA004_SEGMENTO NOT IN (21, 51) 

          AND NSB001_QTDE <> 0 

          AND NSB001_PRODUTO = PVB001_PRODUTO 

          AND NSB001_PRODUTOCONF = PVB001_PRODUTOCONF) SEGMENTO, 

         

        PVB001_QTDEPREV QTD_PREV, 

 

   NVL((SELECT SUM(NSB001_QTDE) 

        FROM NSTBA001 

        JOIN NSTBB001 

          ON NSB001_GRUPO = NSA001_GRUPO 

         AND NSB001_EMPRESA = NSA001_EMPRESA 

         AND NSB001_FILIAL = NSA001_FILIAL 

         AND NSB001_TIPODOC = NSA001_TIPODOC 

         AND NSB001_NOTA = NSA001_NOTA 

         AND NSB001_SERIE = NSA001_SERIE     

        JOIN PPTBA004 

          ON PPA004_GRUPO = NSA001_GRUPO 

         AND PPA004_EMPRESA = NSA001_EMPRESA 

         AND PPA004_PESSOA = NSA001_CLIENTE   

        JOIN TATBA008 

          ON TAA008_GRUPO = NSA001_GRUPO 

         AND TAA008_EMPRESA = NSA001_EMPRESA 

         AND TAA008_CONDICAO = NSA001_CONDICAO 

        WHERE TO_CHAR(NSA001_DTEMISSAO, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY') 

          AND TO_CHAR(NSA001_DTEMISSAO, 'MM') = TO_CHAR(SYSDATE, 'MM') 

          AND NSA001_CANCELADA LIKE 'N' 

          AND TAA008_FATURAMENTO LIKE 'S' 

          AND PPA004_SEGMENTO NOT IN (21, 51) 

          AND NSB001_QTDE <> 0 

          AND NSB001_PRODUTO = PVB001_PRODUTO 

          AND NSB001_PRODUTOCONF = PVB001_PRODUTOCONF),0) QTD_VEND 

 

FROM PVTBB001 

 

LEFT OUTER JOIN ESTBP001 

  ON ESP001_GRUPO = PVB001_GRUPO 

 AND ESP001_EMPRESA = PVB001_EMPRESA 

 AND ESP001_FILIAL = PVB001_FILIAL 

 AND ESP001_PRODUTO = PVB001_PRODUTO 

 AND ESP001_PRODUTOCONF = PVB001_PRODUTOCONF 

 

WHERE PVB001_ANO = TO_CHAR(SYSDATE, 'YYYY') 

  AND PVB001_PERIODO = TO_CHAR(SYSDATE, 'MM') 

 

  AND ESP001_TPPLANEJAM <> 4 

  AND PVB001_QTDEPREV <> 0) 

 

WHERE QTD_VEND <> 0 

  AND (((QTD_VEND / QTD_PREV) * 100) - 100) NOT BETWEEN -15 AND 15) 

   

UNION 

 

SELECT  'FILHO' PERIODO, 

        DECODE(PVA002_PRODUTOCONF, 0, PVA002_PRODUTO, PVA002_PRODUTO||'-'||PVA002_PRODUTOCONF) PRODUTO, 

        CQFBA019(GRUPO, EMPRESA, PVA002_PRODUTO, PVA002_PRODUTOCONF) DESCRICAO, 

        NULL SEGMENTO, 

        NULL QTD_PREV, 

         

   NVL((SELECT SUM(NSB001_QTDE) 

        FROM NSTBA001 

        JOIN NSTBB001 

          ON NSB001_GRUPO = NSA001_GRUPO 

         AND NSB001_EMPRESA = NSA001_EMPRESA 

         AND NSB001_FILIAL = NSA001_FILIAL 

         AND NSB001_TIPODOC = NSA001_TIPODOC 

         AND NSB001_NOTA = NSA001_NOTA 

         AND NSB001_SERIE = NSA001_SERIE     

        JOIN PPTBA004 

          ON PPA004_GRUPO = NSA001_GRUPO 

         AND PPA004_EMPRESA = NSA001_EMPRESA 

         AND PPA004_PESSOA = NSA001_CLIENTE   

        JOIN TATBA008 

          ON TAA008_GRUPO = NSA001_GRUPO 

         AND TAA008_EMPRESA = NSA001_EMPRESA 

         AND TAA008_CONDICAO = NSA001_CONDICAO   

        JOIN TATBA054 

          ON TAA054_GRUPO = NSA001_GRUPO 

         AND TAA054_EMPRESA = NSA001_EMPRESA 

         AND TAA054_SEGMENTO = PPA004_SEGMENTO 

         AND TAA054_GRUPOPESSOA = PPA004_GRUPOPESSOA  

        WHERE TO_CHAR(NSA001_DTEMISSAO, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY') 

          AND TO_CHAR(NSA001_DTEMISSAO, 'MM') = TO_CHAR(SYSDATE, 'MM') 

          AND NSA001_CANCELADA LIKE 'N' 

          AND TAA008_FATURAMENTO LIKE 'S' 

          AND PPA004_SEGMENTO NOT IN (21, 51) 

          AND NSB001_QTDE <> 0 

          AND NSB001_PRODUTO = PVA002_PRODUTO 

          AND NSB001_PRODUTOCONF = PVA002_PRODUTOCONF),0) QTD_VEND, 

         

        NULL MARGEM, 

        TO_CHAR(PRODUTO, 99999999)||TO_CHAR((1000 + PVA002_PERCENTUAL), 99999999)||TO_CHAR(PVA002_PRODUTO, 99999999) SEQUENCIA 

 

FROM 

 

(SELECT * FROM 

 

(SELECT PVB001_GRUPO GRUPO, 

        PVB001_EMPRESA EMPRESA,  

        PVB001_FILIAL FILIAL, 

        PVB001_PERIODO MES, 

        PVB001_ANO ANO, 

        PVB001_PRODUTO PRODUTO, 

        PVB001_PRODUTOCONF PRODUTOCONF, 

        PVB001_QTDEPREV QTD_PREV, 

 

   NVL((SELECT SUM(NSB001_QTDE) 

        FROM NSTBA001 

        JOIN NSTBB001 

          ON NSB001_GRUPO = NSA001_GRUPO 

         AND NSB001_EMPRESA = NSA001_EMPRESA 

         AND NSB001_FILIAL = NSA001_FILIAL 

         AND NSB001_TIPODOC = NSA001_TIPODOC 

         AND NSB001_NOTA = NSA001_NOTA 

         AND NSB001_SERIE = NSA001_SERIE     

        JOIN PPTBA004 

          ON PPA004_GRUPO = NSA001_GRUPO 

         AND PPA004_EMPRESA = NSA001_EMPRESA 

         AND PPA004_PESSOA = NSA001_CLIENTE   

        JOIN TATBA008 

          ON TAA008_GRUPO = NSA001_GRUPO 

         AND TAA008_EMPRESA = NSA001_EMPRESA 

         AND TAA008_CONDICAO = NSA001_CONDICAO   

        JOIN TATBA054 

          ON TAA054_GRUPO = NSA001_GRUPO 

         AND TAA054_EMPRESA = NSA001_EMPRESA 

         AND TAA054_SEGMENTO = PPA004_SEGMENTO 

         AND TAA054_GRUPOPESSOA = PPA004_GRUPOPESSOA  

        WHERE TO_CHAR(NSA001_DTEMISSAO, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY') 

          AND TO_CHAR(NSA001_DTEMISSAO, 'MM') = TO_CHAR(SYSDATE, 'MM') 

          AND NSA001_CANCELADA LIKE 'N' 

          AND TAA008_FATURAMENTO LIKE 'S' 

          AND PPA004_SEGMENTO NOT IN (21, 51) 

          AND NSB001_QTDE <> 0 

          AND NSB001_PRODUTO = PVB001_PRODUTO 

          AND NSB001_PRODUTOCONF = PVB001_PRODUTOCONF),0) QTD_VEND 

 

FROM PVTBB001 

 

LEFT OUTER JOIN ESTBP001 

  ON ESP001_GRUPO = PVB001_GRUPO 

 AND ESP001_EMPRESA = PVB001_EMPRESA 

 AND ESP001_FILIAL = PVB001_FILIAL 

 AND ESP001_PRODUTO = PVB001_PRODUTO 

 AND ESP001_PRODUTOCONF = PVB001_PRODUTOCONF 

 

WHERE PVB001_ANO = TO_CHAR(SYSDATE, 'YYYY') 

  AND PVB001_PERIODO = TO_CHAR(SYSDATE, 'MM') 

 

  AND ESP001_TPPLANEJAM <> 4 

  AND PVB001_QTDEPREV <> 0) 

 

WHERE QTD_VEND <> 0 

  AND (((QTD_VEND / QTD_PREV) * 100) - 100) NOT BETWEEN -15 AND 15) 

 

JOIN PVTBA002 

  ON PVA002_GRUPO = GRUPO 

 AND PVA002_EMPRESA = EMPRESA 

 AND PVA002_FILIAL = FILIAL 

 AND PVA002_PRODUTOG = PRODUTO 

 AND PVA002_PRODUTOCONFG = PRODUTOCONF 

 

WHERE PVA002_DATAINI < SYSDATE 

  AND PVA002_DATAFIM > SYSDATE 

   

UNION 

 

SELECT  'PAI' PERIODO, 

        DECODE(PVA002_PRODUTOCONFG, 0, PVA002_PRODUTOG, PVA002_PRODUTOG||'-'||PVA002_PRODUTOCONFG) PRODUTO, 

        CQFBA019(GRUPO, EMPRESA, PVA002_PRODUTOG, PVA002_PRODUTOCONFG) DESCRICAO, 

        NULL SEGMENTO, 

        NULL QTD_PREV, 

         

   NVL((SELECT SUM(NSB001_QTDE) 

        FROM NSTBA001 

        JOIN NSTBB001 

          ON NSB001_GRUPO = NSA001_GRUPO 

         AND NSB001_EMPRESA = NSA001_EMPRESA 

         AND NSB001_FILIAL = NSA001_FILIAL 

         AND NSB001_TIPODOC = NSA001_TIPODOC 

         AND NSB001_NOTA = NSA001_NOTA 

         AND NSB001_SERIE = NSA001_SERIE     

        JOIN PPTBA004 

          ON PPA004_GRUPO = NSA001_GRUPO 

         AND PPA004_EMPRESA = NSA001_EMPRESA 

         AND PPA004_PESSOA = NSA001_CLIENTE   

        JOIN TATBA008 

          ON TAA008_GRUPO = NSA001_GRUPO 

         AND TAA008_EMPRESA = NSA001_EMPRESA 

         AND TAA008_CONDICAO = NSA001_CONDICAO   

        JOIN TATBA054 

          ON TAA054_GRUPO = NSA001_GRUPO 

         AND TAA054_EMPRESA = NSA001_EMPRESA 

         AND TAA054_SEGMENTO = PPA004_SEGMENTO 

         AND TAA054_GRUPOPESSOA = PPA004_GRUPOPESSOA  

        WHERE TO_CHAR(NSA001_DTEMISSAO, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY') 

          AND TO_CHAR(NSA001_DTEMISSAO, 'MM') = TO_CHAR(SYSDATE, 'MM') 

          AND NSA001_CANCELADA LIKE 'N' 

          AND TAA008_FATURAMENTO LIKE 'S' 

          AND PPA004_SEGMENTO NOT IN (21, 51) 

          AND NSB001_QTDE <> 0 

          AND NSB001_PRODUTO = PVA002_PRODUTOG 

          AND NSB001_PRODUTOCONF = PVA002_PRODUTOCONFG),0) QTD_VEND, 

         

        NULL MARGEM, 

        TO_CHAR(PRODUTO, 99999999)||TO_CHAR((1000 - PVA002_PERCENTUAL), 99999999)||TO_CHAR(PVA002_PRODUTOG, 99999999) SEQUENCIA 

         

FROM 

 

(SELECT * FROM 

 

(SELECT PVB001_GRUPO GRUPO, 

        PVB001_EMPRESA EMPRESA,  

        PVB001_FILIAL FILIAL, 

        PVB001_PERIODO MES, 

        PVB001_ANO ANO, 

        PVB001_PRODUTO PRODUTO, 

        PVB001_PRODUTOCONF PRODUTOCONF, 

        PVB001_QTDEPREV QTD_PREV, 

         

   NVL((SELECT SUM(NSB001_QTDE) 

        FROM NSTBA001 

        JOIN NSTBB001 

          ON NSB001_GRUPO = NSA001_GRUPO 

         AND NSB001_EMPRESA = NSA001_EMPRESA 

         AND NSB001_FILIAL = NSA001_FILIAL 

         AND NSB001_TIPODOC = NSA001_TIPODOC 

         AND NSB001_NOTA = NSA001_NOTA 

         AND NSB001_SERIE = NSA001_SERIE     

        JOIN PPTBA004 

          ON PPA004_GRUPO = NSA001_GRUPO 

         AND PPA004_EMPRESA = NSA001_EMPRESA 

         AND PPA004_PESSOA = NSA001_CLIENTE   

        JOIN TATBA008 

          ON TAA008_GRUPO = NSA001_GRUPO 

         AND TAA008_EMPRESA = NSA001_EMPRESA 

         AND TAA008_CONDICAO = NSA001_CONDICAO   

        JOIN TATBA054 

          ON TAA054_GRUPO = NSA001_GRUPO 

         AND TAA054_EMPRESA = NSA001_EMPRESA 

         AND TAA054_SEGMENTO = PPA004_SEGMENTO 

         AND TAA054_GRUPOPESSOA = PPA004_GRUPOPESSOA  

        WHERE TO_CHAR(NSA001_DTEMISSAO, 'YYYY') = TO_CHAR(SYSDATE, 'YYYY') 

          AND TO_CHAR(NSA001_DTEMISSAO, 'MM') = TO_CHAR(SYSDATE, 'MM') 

          AND NSA001_CANCELADA LIKE 'N' 

          AND TAA008_FATURAMENTO LIKE 'S' 

          AND PPA004_SEGMENTO NOT IN (21, 51) 

          AND NSB001_QTDE <> 0 

          AND NSB001_PRODUTO = PVB001_PRODUTO 

          AND NSB001_PRODUTOCONF = PVB001_PRODUTOCONF),0) QTD_VEND 

 

FROM PVTBB001 

 

LEFT OUTER JOIN ESTBP001 

  ON ESP001_GRUPO = PVB001_GRUPO 

 AND ESP001_EMPRESA = PVB001_EMPRESA 

 AND ESP001_FILIAL = PVB001_FILIAL 

 AND ESP001_PRODUTO = PVB001_PRODUTO 

 AND ESP001_PRODUTOCONF = PVB001_PRODUTOCONF 

 

WHERE PVB001_ANO = TO_CHAR(SYSDATE, 'YYYY') 

  AND PVB001_PERIODO = TO_CHAR(SYSDATE, 'MM') 

 

  AND ESP001_TPPLANEJAM <> 4 

  AND PVB001_QTDEPREV <> 0) 

 

WHERE QTD_VEND <> 0 

  AND (((QTD_VEND / QTD_PREV) * 100) - 100) NOT BETWEEN -15 AND 15) 

 

JOIN PVTBA002 

  ON PVA002_GRUPO = GRUPO 

 AND PVA002_EMPRESA = EMPRESA 

 AND PVA002_FILIAL = FILIAL 

 AND PVA002_PRODUTO = PRODUTO 

 AND PVA002_PRODUTOCONF = PRODUTOCONF 

 

WHERE PVA002_DATAINI < SYSDATE 

  AND PVA002_DATAFIM > SYSDATE 

 

ORDER BY SEQUENCIA