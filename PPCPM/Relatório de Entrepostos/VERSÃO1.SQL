SELECT OCB001_TIPODOC TIPODOC, 
        OCB001_ORDCOMPRA ORDEM, 
        OCB001_LINHA LINHA, 
        OCB001_PRODUTO PRODUTO, 
        OCB001_PRODDESC DESCRICAO, 
        OCB002_NRODOC NRODOC, 
        OCB002_LINHADOC LINHADOC, 
        OCB001_DTENTREGASOL ENTR_SOL, 
        OCB001_DTENTREGAPREV ENTR_PREV, 
        OCB001_QTDESOL QTD_SOL, 
        OCB001_VLRTOTAL VALOR, 
        SUM(ESC002_QUANTIDADE) QTD, 
        ESP001_CONSMEDQTDE CONSUMO, 
        ROUND((CASE WHEN ESP001_CONSMEDQTDE > 0 THEN SUM(ESC002_QUANTIDADE)/ESP001_CONSMEDQTDE END), 2) ESTQ_MES 
 
FROM OCTBB001, OCTBB002,ESTBC002, ESTBP001 
 
WHERE ESC002_PRODUTO = OCB001_PRODUTO 
  AND ESP001_PRODUTO = OCB001_PRODUTO 
  AND OCB002_TIPODOC = OCB001_TIPODOC 
  AND OCB002_ORDCOMPRA = OCB001_ORDCOMPRA 
  AND OCB002_LINHA = OCB001_LINHA 
 
  AND ESP001_FILIAL = 0 
  AND OCB002_NRODOC LIKE 'ENTREPOSTO' 
  AND ESC002_ALMOXARIFADO IN ('1','14') 
  AND OCB001_CODSITUACAO = 1 
 
GROUP BY OCB001_TIPODOC, 
        OCB001_ORDCOMPRA, 
        OCB001_LINHA, 
        OCB001_PRODUTO, 
        OCB001_PRODDESC, 
        OCB002_NRODOC, 
        OCB002_LINHADOC, 
        OCB001_DTENTREGASOL, 
        OCB001_DTENTREGAPREV, 
        OCB001_QTDESOL, 
        OCB001_VLRTOTAL, 
        ESP001_CONSMEDQTDE 
 
ORDER BY OCB001_ORDCOMPRA 