SELECT DECODE(JN_OPERATION, 1, 'Inclusão') OPERACAO, 
        DECODE(PVA002_PRODUTOCONFG, 0, PVA002_PRODUTOG, PVA002_PRODUTOG||'-'||PVA002_PRODUTOCONFG) PRODUTO_ORIG, 
        DECODE(PVA002_PRODUTOCONF, 0, PVA002_PRODUTO, PVA002_PRODUTO||'-'||PVA002_PRODUTOCONF) PRODUTO_FIN, 
        PVA002_PESO PESO, 
        TO_CHAR(PVA002_DATAINI, 'DD/MM/RRRR') DATAINI, 
        TO_CHAR(PVA002_DATAFIM, 'DD/MM/RRRR') DATAFIM, 
        NULL PESO_ANT, 
        NULL DATAINI_ANT, 
        NULL DATAFIM_ANT, 
        JN_ORACLE_USER USUARIO, 
        TO_DATE(JN_DATETIME, 'DD/MM/RRRR') DATA_ALT, 
        TO_CHAR(JN_DATETIME, 'HH24:MI') HORA_ALT 
 
FROM PVTBA002_JN 
 
WHERE JN_NOTES LIKE ('%PVTGA002J2') 
  AND JN_OPERATION = 1 
 
  AND TO_CHAR(JN_DATETIME, 'DD/MM/YYYY') = TO_CHAR(SYSDATE, 'DD/MM/YYYY') 
  AND TO_CHAR(JN_DATETIME, 'HH') = (TO_CHAR(SYSDATE, 'HH') - 1) 
 
UNION 
 
SELECT DECODE(JN_OPERATION, 2, 'Alteração', 3, 'Exclusão') OPERACAO, 
        DECODE(PVA002_PRODUTOCONFG, 0, PVA002_PRODUTOG, PVA002_PRODUTOG||'-'||PVA002_PRODUTOCONFG) PRODUTO_ORIG, 
        DECODE(PVA002_PRODUTOCONF, 0, PVA002_PRODUTO, PVA002_PRODUTO||'-'||PVA002_PRODUTOCONF) PRODUTO_FIN, 
        PVA002_PESO PESO, 
        TO_CHAR(PVA002_DATAINI, 'DD/MM/RRRR') DATAINI, 
        TO_CHAR(PVA002_DATAFIM, 'DD/MM/RRRR') DATAFIM, 
         
       (SELECT PESO_ANT 
        FROM(SELECT PVA002_PRODUTO PRODUTO, 
                    PVA002_PRODUTOCONF PRODUTOCONF, 
                    PVA002_PESO PESO, 
                    LAG(PVA002_PESO, 1) OVER(ORDER BY JN_DATETIME) PESO_ANT, 
                    TO_CHAR(JN_DATETIME, 'DD/MM/RRRR HH24:MI:SS') DATA 
             FROM PVTBA002_JN 
             WHERE PVA002_PRODUTOG = A.PVA002_PRODUTOG 
               AND PVA002_PRODUTOCONFG = A.PVA002_PRODUTOCONFG 
               AND PVA002_PRODUTO = A.PVA002_PRODUTO 
               AND PVA002_PRODUTOCONF = A.PVA002_PRODUTOCONF) 
        WHERE DATA LIKE TO_CHAR(A.JN_DATETIME, 'DD/MM/RRRR HH24:MI:SS')) PESO_ANT, 
         
       (SELECT DATAINI_ANT 
        FROM(SELECT PVA002_PRODUTO PRODUTO, 
                    PVA002_PRODUTOCONF PRODUTOCONF, 
                    TO_CHAR(PVA002_DATAINI, 'DD/MM/RRRR') DATAINI, 
                    LAG(TO_CHAR(PVA002_DATAINI, 'DD/MM/RRRR'), 1) OVER(ORDER BY JN_DATETIME) DATAINI_ANT, 
                    TO_CHAR(JN_DATETIME, 'DD/MM/RRRR HH24:MI:SS') DATA 
             FROM PVTBA002_JN 
             WHERE PVA002_PRODUTOG = A.PVA002_PRODUTOG 
               AND PVA002_PRODUTOCONFG = A.PVA002_PRODUTOCONFG 
               AND PVA002_PRODUTO = A.PVA002_PRODUTO 
               AND PVA002_PRODUTOCONF = A.PVA002_PRODUTOCONF) 
        WHERE DATA LIKE TO_CHAR(A.JN_DATETIME, 'DD/MM/RRRR HH24:MI:SS')) DATAINI_ANT, 
         
       (SELECT DATAFIM_ANT 
        FROM(SELECT PVA002_PRODUTO PRODUTO, 
                    PVA002_PRODUTOCONF PRODUTOCONF, 
                    TO_CHAR(PVA002_DATAFIM, 'DD/MM/RRRR') DATAFIM, 
                    LAG(TO_CHAR(PVA002_DATAFIM, 'DD/MM/RRRR'), 1) OVER(ORDER BY JN_DATETIME) DATAFIM_ANT, 
                    TO_CHAR(JN_DATETIME, 'DD/MM/RRRR HH24:MI:SS') DATA 
             FROM PVTBA002_JN 
             WHERE PVA002_PRODUTOG = A.PVA002_PRODUTOG 
               AND PVA002_PRODUTOCONFG = A.PVA002_PRODUTOCONFG 
               AND PVA002_PRODUTO = A.PVA002_PRODUTO 
               AND PVA002_PRODUTOCONF = A.PVA002_PRODUTOCONF) 
        WHERE DATA LIKE TO_CHAR(A.JN_DATETIME, 'DD/MM/RRRR HH24:MI:SS')) DATAFIM_ANT, 
         
        JN_ORACLE_USER USUARIO, 
        TO_DATE(JN_DATETIME, 'DD/MM/RRRR') DATA_ALT, 
        TO_CHAR(JN_DATETIME, 'HH24:MI') HORA_ALT 
 
FROM PVTBA002_JN A 
 
WHERE JN_NOTES LIKE ('%PVTGA002J2') 
  AND JN_OPERATION IN (2,3) 
 
  AND TO_CHAR(JN_DATETIME, 'DD/MM/YYYY') = TO_CHAR(SYSDATE, 'DD/MM/YYYY') 
  AND TO_CHAR(JN_DATETIME, 'HH') = (TO_CHAR(SYSDATE, 'HH') - 1) 
 
ORDER BY DATA_ALT DESC, HORA_ALT 
