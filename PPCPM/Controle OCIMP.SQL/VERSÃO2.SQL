SELECT  OCB001_ORDCOMPRA||'-'||OCB001_LINHA ORDEM,  
        OCA001_FORNECEDOR||'-'||PPA001_NOME FORNECEDOR,  
 
 DECODE(OCB001_PRODUTOCONF, 0, OCB001_PRODUTO, OCB001_PRODUTO||'-'||OCB001_PRODUTOCONF) PRODUTO, 
         
        OCB001_PRODDESC DESCRICAO,  
        OCB001_QTDESOL QTD_SOL, 
        OCB001_VLRTOTAL VALOR, 
        OCB001_QTDEABE QTD_ABERTO, 
        
       (OCB001_PRECOLIQUIDO * OCB001_QTDEABE) VALOR_ABERTO, 
         
        OCA001_DTEMISSAO EMISSAO, 
        OCB001_DTENTREGASOL ENTR_SOL, 
        OCB001_DTENTREGAPREV ENTR_PREV, 
 
        NULL STATUS, 
        NULL INVOICE, 
 
       (SELECT LISTAGG(IEA002_PROCESSO, '-') WITHIN GROUP (ORDER BY IEA002_PROCESSO) 
        FROM IETBA002 
        WHERE IEA002_GRUPO = OCA001_GRUPO 
          AND IEA002_EMPRESA = OCA001_EMPRESA 
          AND IEA002_FILIAL = OCA001_FILIAL 
          AND IEA002_TIPODOCOC = OCA001_TIPODOC 
          AND IEA002_ORDCOMPRA = OCA001_ORDCOMPRA) PIMP, 
 
       (SELECT LISTAGG(IEA001_DESCRICAO, '-') WITHIN GROUP (ORDER BY IEA002_PROCESSO) 
        FROM IETBA001, IETBA002 
        WHERE IEA001_GRUPO = IEA002_GRUPO 
          AND IEA001_EMPRESA = IEA002_EMPRESA 
          AND IEA001_FILIAL = IEA002_FILIAL 
          AND IEA001_TIPODOC = IEA002_TIPODOC 
          AND IEA001_PROCESSO = IEA002_PROCESSO 
 
          AND IEA002_GRUPO = OCA001_GRUPO 
          AND IEA002_EMPRESA = OCA001_EMPRESA 
          AND IEA002_FILIAL = OCA001_FILIAL 
          AND IEA002_TIPODOCOC = OCA001_TIPODOC 
          AND IEA002_ORDCOMPRA = OCA001_ORDCOMPRA) AGENTE_CARGA, 
 
       (SELECT LISTAGG(IEA001_NRODECLARIMP, '-') WITHIN GROUP (ORDER BY IEA002_PROCESSO) 
        FROM IETBA001, IETBA002 
        WHERE IEA001_GRUPO = IEA002_GRUPO 
          AND IEA001_EMPRESA = IEA002_EMPRESA 
          AND IEA001_FILIAL = IEA002_FILIAL 
          AND IEA001_TIPODOC = IEA002_TIPODOC 
          AND IEA001_PROCESSO = IEA002_PROCESSO 
 
          AND IEA002_GRUPO = OCA001_GRUPO 
          AND IEA002_EMPRESA = OCA001_EMPRESA 
          AND IEA002_FILIAL = OCA001_FILIAL 
          AND IEA002_TIPODOCOC = OCA001_TIPODOC 
          AND IEA002_ORDCOMPRA = OCA001_ORDCOMPRA) DI, 
 
       (SELECT LISTAGG(IEA001_NROREGISTEXP, '-') WITHIN GROUP (ORDER BY IEA002_PROCESSO) 
        FROM IETBA001, IETBA002 
        WHERE IEA001_GRUPO = IEA002_GRUPO 
          AND IEA001_EMPRESA = IEA002_EMPRESA 
          AND IEA001_FILIAL = IEA002_FILIAL 
          AND IEA001_TIPODOC = IEA002_TIPODOC 
          AND IEA001_PROCESSO = IEA002_PROCESSO 
 
          AND IEA002_GRUPO = OCA001_GRUPO 
          AND IEA002_EMPRESA = OCA001_EMPRESA 
          AND IEA002_FILIAL = OCA001_FILIAL 
          AND IEA002_TIPODOCOC = OCA001_TIPODOC 
          AND IEA002_ORDCOMPRA = OCA001_ORDCOMPRA) PROTOCOLO_DI, 
 
       (SELECT LISTAGG(TAC001_DESCRICAO, '-') WITHIN GROUP (ORDER BY IEA002_PROCESSO) 
        FROM IETBA001, IETBA002, TATBC001 
        WHERE TAC001_TIPOCONHEC = IEA001_TIPOCONHECIMENTO 
          AND IEA001_GRUPO = IEA002_GRUPO 
          AND IEA001_EMPRESA = IEA002_EMPRESA 
          AND IEA001_FILIAL = IEA002_FILIAL 
          AND IEA001_TIPODOC = IEA002_TIPODOC 
          AND IEA001_PROCESSO = IEA002_PROCESSO 
 
          AND IEA002_GRUPO = OCA001_GRUPO 
          AND IEA002_EMPRESA = OCA001_EMPRESA 
          AND IEA002_FILIAL = OCA001_FILIAL 
          AND IEA002_TIPODOCOC = OCA001_TIPODOC 
          AND IEA002_ORDCOMPRA = OCA001_ORDCOMPRA) TIPO_CONHECIMENTO, 
 
        NULL PIMP_ENTREPOSTO, 
        NULL DI_ENTREPOSTO, 
        NULL PROTOCOLO_DI_ENTREPOSTO, 
 
       (SELECT LISTAGG(IEA002_NOTAENTRADA, '-') WITHIN GROUP (ORDER BY IEA002_PROCESSO) 
        FROM IETBA002 
        WHERE IEA002_GRUPO = OCA001_GRUPO 
          AND IEA002_EMPRESA = OCA001_EMPRESA 
          AND IEA002_FILIAL = OCA001_FILIAL 
          AND IEA002_TIPODOCOC = OCA001_TIPODOC 
          AND IEA002_ORDCOMPRA = OCA001_ORDCOMPRA) NFE, 
 
        OCB001_CLAFISCAL CLAFISCAL, 
 
       (SELECT PAN001_PARTNUMBER 
        FROM PATBN001 
        WHERE OCB001_PAN001_ID = PAN001_ID) PARTNUMBER, 
 
       (SELECT TAB003_NOMEMARCA 
        FROM PATBN001, TATBB003 
        WHERE OCB001_PAN001_ID = PAN001_ID 
          AND TAB003_NROREGISTRO = PAN001_MARCA) MARCA, 
         
        OCB001_OPERACAO OPERACAO, 
        OCB001_NATUREZA NATUREZA, 
 
       (SELECT STRING_AGG(FOC001_DESCSECU) 
        FROM FOTBC001 
        WHERE FOC001_GRUPO = OCA001_GRUPO 
          AND FOC001_EMPRESA = OCA001_EMPRESA 
          AND FOC001_FORNECEDOR = OCA001_FORNECEDOR 
           
          AND FOC001_PRODUTO = OCB001_PRODUTO 
          AND FOC001_PRODUTOCONF = OCB001_PRODUTOCONF) DESC_SECUNDARIA, 
           
        NULL TIPO_PAGAMENTO1, 
        NULL TIPO_PAGAMENTO2, 
        NULL TIPO_PAGAMENTO3, 
        NULL TIPO_PAGAMENTO4, 
        NULL TIPO_PAGAMENTO5, 
           
       (SELECT LISTAGG(CON001_DTCONTRATO, '-') WITHIN GROUP (ORDER BY CON001_NROCONTRATO) 
        FROM COTBN001, COTBN002, IETBA002 
        WHERE CON002_CON001_ID = CON001_ID 
         
          AND CON002_GRUPO = IEA002_GRUPO 
          AND CON002_EMPRESA = IEA002_EMPRESA 
          AND CON002_FILIAL = IEA002_FILIAL 
          AND CON002_TIPODOCIE = IEA002_TIPODOC 
          AND CON002_PROCESSOIE = IEA002_PROCESSO 
         
          AND IEA002_GRUPO = OCA001_GRUPO 
          AND IEA002_EMPRESA = OCA001_EMPRESA 
          AND IEA002_FILIAL = OCA001_FILIAL 
          AND IEA002_TIPODOCOC = OCA001_TIPODOC 
          AND IEA002_ORDCOMPRA = OCA001_ORDCOMPRA) DATA_CONTRATO, 
 
       (SELECT LISTAGG(CON001_NROCONTRATO, '-') WITHIN GROUP (ORDER BY CON001_NROCONTRATO) 
        FROM COTBN001, COTBN002, IETBA002 
        WHERE CON002_CON001_ID = CON001_ID 
         
          AND CON002_GRUPO = IEA002_GRUPO 
          AND CON002_EMPRESA = IEA002_EMPRESA 
          AND CON002_FILIAL = IEA002_FILIAL 
          AND CON002_TIPODOCIE = IEA002_TIPODOC 
          AND CON002_PROCESSOIE = IEA002_PROCESSO 
         
          AND IEA002_GRUPO = OCA001_GRUPO 
          AND IEA002_EMPRESA = OCA001_EMPRESA 
          AND IEA002_FILIAL = OCA001_FILIAL 
          AND IEA002_TIPODOCOC = OCA001_TIPODOC 
          AND IEA002_ORDCOMPRA = OCA001_ORDCOMPRA) CONTRATO, 
 
       (SELECT LISTAGG(CON001_COTACAO, '-') WITHIN GROUP (ORDER BY CON001_NROCONTRATO) 
        FROM COTBN001, COTBN002, IETBA002 
        WHERE CON002_CON001_ID = CON001_ID 
         
          AND CON002_GRUPO = IEA002_GRUPO 
          AND CON002_EMPRESA = IEA002_EMPRESA 
          AND CON002_FILIAL = IEA002_FILIAL 
          AND CON002_TIPODOCIE = IEA002_TIPODOC 
          AND CON002_PROCESSOIE = IEA002_PROCESSO 
         
          AND IEA002_GRUPO = OCA001_GRUPO 
          AND IEA002_EMPRESA = OCA001_EMPRESA 
          AND IEA002_FILIAL = OCA001_FILIAL 
          AND IEA002_TIPODOCOC = OCA001_TIPODOC 
          AND IEA002_ORDCOMPRA = OCA001_ORDCOMPRA) TAXA_DOLAR, 
     
        NULL INST_FINANCEIRA1, 
        NULL INST_FINANCEIRA2, 
        NULL INST_FINANCEIRA3, 
        NULL INST_FINANCEIRA4, 
        NULL INST_FINANCEIRA5 
 
FROM OCTBA001, OCTBB001, PPTBA001 
 
WHERE OCB001_GRUPO = OCA001_GRUPO 
  AND OCB001_EMPRESA = OCA001_EMPRESA 
  AND OCB001_FILIAL = OCA001_FILIAL 
  AND OCB001_TIPODOC = OCA001_TIPODOC 
  AND OCB001_ORDCOMPRA = OCA001_ORDCOMPRA 
 
  AND PPA001_GRUPO = OCA001_GRUPO 
  AND PPA001_EMPRESA = OCA001_EMPRESA 
  AND PPA001_PESSOA = OCA001_FORNECEDOR 
 
  AND OCA001_DTEMISSAO BETWEEN :PERIODO AND :AAA 
 
  AND OCB001_ORDCOMPRA LIKE NVL(:ORDEM, '%') 
  AND OCB001_PRODUTO LIKE NVL(:PRODUTO, '%') 
 
  AND OCB001_SITUACAO = 1 
  AND OCA001_TIPODOC LIKE 'OCIMP' 
 
ORDER BY OCA001_DTEMISSAO 