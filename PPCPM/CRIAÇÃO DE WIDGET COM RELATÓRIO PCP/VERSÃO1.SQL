SELECT DECODE(ESC001_PRODUTOCONF, 0, ESC001_PRODUTO, ESC001_PRODUTO||'-'||ESC001_PRODUTOCONF) PRODUTO, 
        CQFBA019(ESC001_GRUPO, ESC001_EMPRESA, ESC001_PRODUTO, ESC001_PRODUTOCONF) DESCRICAO, 
        ESA001_UMEST UM, 
        EFPGE270.EFFPE270017(ESC001_GRUPO, ESC001_EMPRESA, ESC001_PRODUTO, ESC001_PRODUTOCONF, 'N') ESTOQUE, 
        EFPGE270.EFFPE270017(ESC001_GRUPO, ESC001_EMPRESA, ESC001_PRODUTO, ESC001_PRODUTOCONF, 'N') -  
        NVL((SELECT SUM(RMC001_QTDESOL) - SUM(RMC001_QTDECAN) 
            FROM RMTBC001 
            WHERE RMC001_SITUACAO = 1 
              AND RMC001_GRUPO = ESA001_GRUPO 
              AND RMC001_EMPRESA = ESA001_EMPRESA 
              AND RMC001_PRODUTO = ESC001_PRODUTO 
              AND RMC001_PRODUTOCONF = ESC001_PRODUTOCONF), 0) SALDO, 
       (SELECT STRING_AGG(OPB001_TIPODOC||'-'||OPB001_ORDEM||'-'||OPB001_LINHA) 
        FROM OPTBB001, RMTBC001 
        WHERE RMC001_GRUPO = OPB001_GRUPO 
          AND RMC001_EMPRESA = OPB001_EMPRESA 
          AND RMC001_FILIAL = OPB001_FILIAL 
          AND RMC001_TIPODOCOP = OPB001_TIPODOC 
          AND RMC001_ORDEM = OPB001_ORDEM 
          AND RMC001_LINHAOP = OPB001_LINHA 
          AND RMC001_PRODUTO = ESC001_PRODUTO 
          AND RMC001_PRODUTOCONF = ESC001_PRODUTOCONF 
          AND OPB001_SITUACAO = 1) ORDEM, 
           
        NULL DATASIMUL, 
        NULL RECURSO, 
        NULL QTDSOL, 
        NULL QTDATE, 
        NULL ALMOXORIG, 
        NULL ALMOXDEST  
FROM ESTBA001, ESTBC001  
WHERE ESC001_FILIAL = 0   
  AND ESC001_GRUPO = ESA001_GRUPO 
  AND ESC001_EMPRESA = ESA001_EMPRESA 
  AND ESC001_PRODUTO = ESA001_PRODUTO   
  AND ESC001_PRODUTO = :PRODUTO 
  AND ESC001_PRODUTOCONF LIKE NVL(:CONF, '%')  
UNION ALL 
SELECT DECODE(OPS012_PRODUTOCONF, 0, OPS012_PRODUTO, OPS012_PRODUTO||'-'||OPS012_PRODUTOCONF) PRODUTO, 
        OPS012_PRODDESC DESCRICAO, 
        OPS012_UM UM, 
         
        NULL ESTOQUE, 
        NULL SALDO, 
         
        OPS012_TIPODOC||'-'||OPS012_ORDEM||'-'||OPS012_LINHA ORDEM, 
         
   MAX((SELECT MAX(A.OPS012_DATASIMUL) 
        FROM OPTBS011, OPTBS012 A 
        WHERE A.OPS012_OPS011_ID = OPS011_ID 
          AND A.OPS012_GRUPO = RMC001_GRUPO 
          AND A.OPS012_EMPRESA = RMC001_EMPRESA 
          AND A.OPS012_FILIAL = RMC001_FILIAL 
          AND A.OPS012_TIPODOC = RMC001_TIPODOCOP 
          AND A.OPS012_ORDEM = RMC001_ORDEM 
          AND A.OPS012_LINHA = RMC001_LINHAOP 
          AND OPS011_STATUS = 2)) DATASIMUL, 
   
        MPB001_RECURSO||'-'||MPB001_DESCRICAO RECURSO, 
        OPS012_QTDESOL QTDSOL,  
        OPS012_QTDEATE QTDATE, 
        RMC001_AXORIGEM ALMOXORIG, 
        RMC001_AXDESTINO ALMOXDEST 
FROM RMTBC001, OPTBS012, MPTBB001 
WHERE RMC001_GRUPO = OPS012_GRUPO 
  AND RMC001_EMPRESA = OPS012_EMPRESA 
  AND RMC001_FILIAL = OPS012_FILIAL 
  AND RMC001_TIPODOCOP = OPS012_TIPODOC 
  AND RMC001_ORDEM = OPS012_ORDEM 
  AND RMC001_LINHAOP = OPS012_LINHA 
   
  AND MPB001_GRUPO = OPS012_GRUPO 
  AND MPB001_EMPRESA = OPS012_EMPRESA 
  AND MPB001_RECURSO = OPS012_RECURSO 
   
  AND RMC001_PRODUTO = :PRODUTO 
  AND RMC001_PRODUTOCONF LIKE NVL(:CONF, '%') 
   
  AND RMC001_SITUACAO = 1 
GROUP BY OPS012_PRODUTO, 
        OPS012_PRODUTOCONF, 
        OPS012_PRODDESC, 
        OPS012_UM, 
        OPS012_TIPODOC, 
        OPS012_ORDEM, 
        OPS012_LINHA, 
        MPB001_RECURSO, 
        MPB001_DESCRICAO, 
        OPS012_QTDESOL, 
        OPS012_QTDEATE, 
        RMC001_AXORIGEM, 
        RMC001_AXDESTINO 