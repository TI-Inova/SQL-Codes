SELECT DECODE(ESC001_PRODUTOCONF, 0, ESC001_PRODUTO, ESC001_PRODUTO||'-'||ESC001_PRODUTOCONF) PRODUTO, 
        CQFBA019(ESC001_GRUPO, ESC001_EMPRESA, ESC001_PRODUTO, ESC001_PRODUTOCONF) DESCRICAO, 
        ESA001_UMEST UM, 
         
        EFPGE270.EFFPE270017(ESC001_GRUPO, ESC001_EMPRESA, ESC001_PRODUTO, ESC001_PRODUTOCONF, 'N') ESTOQUE, 
 
       (EFPGE270.EFFPE270017(ESC001_GRUPO, ESC001_EMPRESA, ESC001_PRODUTO, ESC001_PRODUTOCONF, 'N')) - 
       (SELECT SUM(RMC001_QTDESOL) - SUM(RMC001_QTDECAN) 
        FROM RMTBC001 
        WHERE RMC001_SITUACAO = 1 
          AND RMC001_GRUPO = ESA001_GRUPO 
          AND RMC001_EMPRESA = ESA001_EMPRESA 
          AND RMC001_PRODUTO = ESC001_PRODUTO 
          AND RMC001_PRODUTOCONF = ESC001_PRODUTOCONF) SALDO, 
 
       (SELECT STRING_AGG(OPB001_TIPODOC||'-'||OPB001_ORDEM||'-'||OPB001_LINHA) 
        FROM OPTBB001, RMTBC001 
        WHERE RMC001_GRUPO = OPB001_GRUPO 
          AND RMC001_EMPRESA = OPB001_EMPRESA 
          AND RMC001_FILIAL = OPB001_FILIAL 
          AND RMC001_TIPODOCOP = OPB001_TIPODOC 
          AND RMC001_ORDEM = OPB001_ORDEM 
          AND RMC001_LINHAOP = OPB001_LINHA 
          AND RMC001_PRODUTO = ESC001_PRODUTO 
          AND RMC001_PRODUTOCONF = ESC001_PRODUTOCONF 
          AND OPB001_SITUACAO = 1) ORDEM, 
           
        NULL DATASIMUL, 
        NULL RECURSO, 
        NULL QTDSOL, 
        NULL QTDATE, 
        NULL ALMOXORIG, 
        NULL ALMOXDEST 
 
FROM ESTBA001, ESTBC001 
 
WHERE ESC001_FILIAL = 0 
 
  AND ESC001_GRUPO = ESA001_GRUPO 
  AND ESC001_EMPRESA = ESA001_EMPRESA 
  AND ESC001_PRODUTO = ESA001_PRODUTO 
 
  AND ESC001_PRODUTO = :PRODUTO 
  AND ESC001_PRODUTOCONF LIKE NVL(:CONF, '%') 
 
UNION ALL 
 
SELECT DECODE(OPB001_PRODUTOCONF, 0, OPB001_PRODUTO, OPB001_PRODUTO||'-'||OPB001_PRODUTOCONF) PRODUTO, 
        CQFBA019(OPB001_GRUPO, OPB001_EMPRESA, OPB001_PRODUTO, OPB001_PRODUTOCONF) DESCRICAO, 
        OPB001_UM UM, 
         
        NULL ESTOQUE, 
        NULL SALDO, 
         
        OPB001_TIPODOC||'-'||OPB001_ORDEM||'-'||OPB001_LINHA ORDEM, 
         
       (SELECT MAX(OPS012_DATASIMUL) 
        FROM OPTBS011, OPTBS012 
        WHERE OPS012_OPS011_ID = OPS011_ID 
          AND OPS012_GRUPO = RMC001_GRUPO 
          AND OPS012_EMPRESA = RMC001_EMPRESA 
          AND OPS012_FILIAL = RMC001_FILIAL 
          AND OPS012_TIPODOC = RMC001_TIPODOCOP 
          AND OPS012_ORDEM = RMC001_ORDEM 
          AND OPS012_LINHA = RMC001_LINHAOP 
          AND OPS011_STATUS = 2) DATASIMUL, 
         
       (SELECT STRING_AGG(DISTINCT MPB001_RECURSO||'-'||MPB001_DESCRICAO) 
        FROM OPTBS011, OPTBS012, MPTBB001 
        WHERE OPS012_OPS011_ID = OPS011_ID 
          AND OPS012_GRUPO = RMC001_GRUPO 
          AND OPS012_EMPRESA = RMC001_EMPRESA 
          AND OPS012_FILIAL = RMC001_FILIAL 
          AND OPS012_TIPODOC = RMC001_TIPODOCOP 
          AND OPS012_ORDEM = RMC001_ORDEM 
          AND OPS012_LINHA = RMC001_LINHAOP 
          AND MPB001_GRUPO = OPS012_GRUPO 
          AND MPB001_EMPRESA = OPS012_EMPRESA 
          AND MPB001_RECURSO = OPS012_RECURSO 
          AND OPS011_STATUS = 2) RECURSO, 
 
        RMC001_QTDESOL - RMC001_QTDECAN QTDSOL, 
        RMC001_QTDEATE QTDATE, 
        RMC001_AXORIGEM ALMOXORIG, 
        RMC001_AXDESTINO ALMOXDEST 
 
FROM RMTBC001, OPTBB001 
 
WHERE RMC001_GRUPO = OPB001_GRUPO 
  AND RMC001_EMPRESA = OPB001_EMPRESA 
  AND RMC001_FILIAL = OPB001_FILIAL 
  AND RMC001_TIPODOCOP = OPB001_TIPODOC 
  AND RMC001_ORDEM = OPB001_ORDEM 
  AND RMC001_LINHAOP = OPB001_LINHA 
   
  AND RMC001_PRODUTO = :PRODUTO 
  AND RMC001_PRODUTOCONF LIKE NVL(:CONF, '%') 
   
  AND RMC001_SITUACAO = 1 